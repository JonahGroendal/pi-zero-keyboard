<!DOCTYPE html>
<html class="fontawesome-i2svg-active fontawesome-i2svg-complete"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <style type="text/css">svg:not(:root).svg-inline--fa{overflow:visible}.svg-inline--fa{display:inline-block;font-size:inherit;height:1em;overflow:visible;vertical-align:-.125em}.svg-inline--fa.fa-lg{vertical-align:-.225em}.svg-inline--fa.fa-w-1{width:.0625em}.svg-inline--fa.fa-w-2{width:.125em}.svg-inline--fa.fa-w-3{width:.1875em}.svg-inline--fa.fa-w-4{width:.25em}.svg-inline--fa.fa-w-5{width:.3125em}.svg-inline--fa.fa-w-6{width:.375em}.svg-inline--fa.fa-w-7{width:.4375em}.svg-inline--fa.fa-w-8{width:.5em}.svg-inline--fa.fa-w-9{width:.5625em}.svg-inline--fa.fa-w-10{width:.625em}.svg-inline--fa.fa-w-11{width:.6875em}.svg-inline--fa.fa-w-12{width:.75em}.svg-inline--fa.fa-w-13{width:.8125em}.svg-inline--fa.fa-w-14{width:.875em}.svg-inline--fa.fa-w-15{width:.9375em}.svg-inline--fa.fa-w-16{width:1em}.svg-inline--fa.fa-w-17{width:1.0625em}.svg-inline--fa.fa-w-18{width:1.125em}.svg-inline--fa.fa-w-19{width:1.1875em}.svg-inline--fa.fa-w-20{width:1.25em}.svg-inline--fa.fa-pull-left{margin-right:.3em;width:auto}.svg-inline--fa.fa-pull-right{margin-left:.3em;width:auto}.svg-inline--fa.fa-border{height:1.5em}.svg-inline--fa.fa-li{width:2em}.svg-inline--fa.fa-fw{width:1.25em}.fa-layers svg.svg-inline--fa{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.fa-layers{display:inline-block;height:1em;position:relative;text-align:center;vertical-align:-.125em;width:1em}.fa-layers svg.svg-inline--fa{-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter,.fa-layers-text{display:inline-block;position:absolute;text-align:center}.fa-layers-text{left:50%;top:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter{background-color:#ff253a;border-radius:1em;-webkit-box-sizing:border-box;box-sizing:border-box;color:#fff;height:1.5em;line-height:1;max-width:5em;min-width:1.5em;overflow:hidden;padding:.25em;right:0;text-overflow:ellipsis;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-bottom-right{bottom:0;right:0;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom right;transform-origin:bottom right}.fa-layers-bottom-left{bottom:0;left:0;right:auto;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom left;transform-origin:bottom left}.fa-layers-top-right{right:0;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-top-left{left:0;right:auto;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top left;transform-origin:top left}.fa-lg{font-size:1.3333333333em;line-height:.75em;vertical-align:-.0667em}.fa-xs{font-size:.75em}.fa-sm{font-size:.875em}.fa-1x{font-size:1em}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-6x{font-size:6em}.fa-7x{font-size:7em}.fa-8x{font-size:8em}.fa-9x{font-size:9em}.fa-10x{font-size:10em}.fa-fw{text-align:center;width:1.25em}.fa-ul{list-style-type:none;margin-left:2.5em;padding-left:0}.fa-ul>li{position:relative}.fa-li{left:-2em;position:absolute;text-align:center;width:2em;line-height:inherit}.fa-border{border:solid .08em #eee;border-radius:.1em;padding:.2em .25em .15em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left,.fab.fa-pull-left,.fal.fa-pull-left,.far.fa-pull-left,.fas.fa-pull-left{margin-right:.3em}.fa.fa-pull-right,.fab.fa-pull-right,.fal.fa-pull-right,.far.fa-pull-right,.fas.fa-pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.fa-rotate-90{-webkit-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-webkit-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-webkit-transform:scale(-1,1);transform:scale(-1,1)}.fa-flip-vertical{-webkit-transform:scale(1,-1);transform:scale(1,-1)}.fa-flip-both,.fa-flip-horizontal.fa-flip-vertical{-webkit-transform:scale(-1,-1);transform:scale(-1,-1)}:root .fa-flip-both,:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-rotate-90{-webkit-filter:none;filter:none}.fa-stack{display:inline-block;height:2em;position:relative;width:2.5em}.fa-stack-1x,.fa-stack-2x{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.svg-inline--fa.fa-stack-1x{height:1em;width:1.25em}.svg-inline--fa.fa-stack-2x{height:2em;width:2.5em}.fa-inverse{color:#fff}.sr-only{border:0;clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.sr-only-focusable:active,.sr-only-focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}.svg-inline--fa .fa-primary{fill:var(--fa-primary-color,currentColor);opacity:1;opacity:var(--fa-primary-opacity,1)}.svg-inline--fa .fa-secondary{fill:var(--fa-secondary-color,currentColor);opacity:.4;opacity:var(--fa-secondary-opacity,.4)}.svg-inline--fa.fa-swap-opacity .fa-primary{opacity:.4;opacity:var(--fa-secondary-opacity,.4)}.svg-inline--fa.fa-swap-opacity .fa-secondary{opacity:1;opacity:var(--fa-primary-opacity,1)}.svg-inline--fa mask .fa-primary,.svg-inline--fa mask .fa-secondary{fill:#000}.fad.fa-inverse{color:#fff}</style><link rel="icon" type="image/png" sizes="16x16" href="https://www.rmedgar.com/favicon-16x16.png">

    <title>Using RPi Zero as a Keyboard Part 1: Setup and device definition | rmed</title>

        <link rel="stylesheet" type="text/css" href="Tutorial%20%20Part%201%20Setup%20and%20device%20definition_files/style.css">

    <meta charset="utf-8">
    <meta name="distribution" content="global">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:site_name" content="rmed">
    <meta name="twitter:card" content="summary">
<meta property="og:title" content="Using RPi Zero as a Keyboard Part 1: Setup and device definition">
<meta property="og:type" content="article">
<meta property="og:url" content="blog/using-rpi-zero-as-keyboard-setup-and-device-definition">
<meta property="og:description" content="The Raspberry Pi Zero is a cool little piece of hardware with many possibilities. One of them is that it can work as a USB host OR as a USB gadget, meaning that it is possible to implement different types of devices such as ethernet, HID (keyboard, mouse, gamepad, etc â€¦">
<meta property="og:locale" content="en">
<meta property="article:published_time" content="2017-06-26 14:40:00+02:00">
<meta property="article:modified_time" content="2017-06-26 14:40:00+02:00">
<meta property="article:author" content="rmed"><meta property="article:tag" content="hid"><meta property="article:tag" content="linux"><meta property="article:tag" content="zero"><meta property="article:tag" content="keyboard"><meta property="article:tag" content="pi"><meta property="article:tag" content="rpi"><meta property="article:tag" content="gadget"><meta property="article:tag" content="configfs"><meta property="article:tag" content="raspberry pi">
<script type="text/javascript" async="" src="Tutorial%20%20Part%201%20Setup%20and%20device%20definition_files/matomo.js"></script><script type="text/javascript">
  var _paq = window._paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//stats.rmedgar.com/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
        <script type="text/javascript" src="Tutorial%20%20Part%201%20Setup%20and%20device%20definition_files/main.js" charset="utf-8"></script>

        <script type="module" src="Tutorial%20%20Part%201%20Setup%20and%20device%20definition_files/fa.js" charset="utf-8"></script>

<script src="Tutorial%20%20Part%201%20Setup%20and%20device%20definition_files/embed.js" defer="defer"></script><style></style></head>

<body><div role="dialog" aria-live="polite" aria-label="cookieconsent" aria-describedby="cookieconsent:desc" class="cc-window cc-floating cc-type-info cc-theme-block cc-bottom cc-right cc-color-override-1396553019 " style=""><!--googleoff: all--><span id="cookieconsent:desc" class="cc-message">This
 website gathers anonymous statistics, which you may opt-out of at any 
time, and may optionally store personal information when publishing 
comments. <a aria-label="learn more about cookies" role="button" tabindex="0" class="cc-link" href="https://www.rmedgar.com/privacy" rel="noopener noreferrer nofollow" target="_blank">Learn more</a></span><div class="cc-compliance"><a aria-label="dismiss cookie message" role="button" tabindex="0" class="cc-btn cc-dismiss">Ok</a></div><!--googleon: all--></div>
    <section class="hero is-dark with-navbar">
        <div class="hero-body">
            <div class="container">
                <div id="social-links">
                        <a class="is-size-3" href="https://github.com/rmed" target="_blank">
                            <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github"></i> Font Awesome fontawesome.com -->
                        </a>
                        <a class="is-size-3" href="https://twitter.com/rmed_dev" target="_blank">
                            <svg class="svg-inline--fa fa-twitter fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg><!-- <i class="fab fa-twitter"></i> Font Awesome fontawesome.com -->
                        </a>
                        <a class="is-size-3" href="https://linkedin.com/in/rmedgar" target="_blank">
                            <svg class="svg-inline--fa fa-linkedin fa-w-14" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg><!-- <i class="fab fa-linkedin"></i> Font Awesome fontawesome.com -->
                        </a>
                </div>
                <h1 class="title">rmed</h1>
                <h2 class="subtitle">blog</h2>
            </div>
        </div>
    </section>

    <nav class="navbar is-primary mb-4" role="navigation" aria-label="main navigation">
        <div class="container">
            <div class="navbar-brand">
                <a id="navbar-toggle" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="nav-menu">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>

            <div id="nav-menu" class="navbar-menu">
                <div class="navbar-start">
                        <a class="navbar-item" href="https://www.rmedgar.com/">Home</a>
                        <a class="navbar-item" href="https://www.rmedgar.com/blog">Blog</a>
                        <a class="navbar-item" href="https://www.rmedgar.com/projects">Projects</a>
                        <a class="navbar-item" href="https://www.rmedgar.com/academic">Academic</a>
                        <a class="navbar-item" href="https://www.rmedgar.com/about">About me</a>
                        <a class="navbar-item" href="https://www.rmedgar.com/privacy">Privacy</a>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
<div class="container">
    <article class="post">
        <h2 class="title is-2">
            <a href="https://www.rmedgar.com/blog/using-rpi-zero-as-keyboard-setup-and-device-definition">Using RPi Zero as a Keyboard Part 1: Setup and device definition</a>
        </h2>

        <div class="columns">
            <div class="column is-4">
                    <span>
                        <a href="https://www.rmedgar.com/blog/by/rmed">rmed</a>
                    </span>
            </div>
            <div class="column is-4 is-offset-4 has-text-right">
                <span><i>2017-06-26 14:40</i></span>
            </div>
        </div>

        <div class="content">
            <p>The Raspberry Pi Zero is a cool little piece of hardware with many possibilities. One of them is that it can work as a USB host <em>OR</em>
 as a USB gadget, meaning that it is possible to implement different 
types of devices such as ethernet, HID (keyboard, mouse, gamepad, etc.),
 audio, mass storage, etc. In this 3-part series of post we'll see how 
to configure and use a simple and generic keyboard gadget to send keys 
to the connected host.</p>
<p>In this part I'll go over the process of defining the gadget, 
breaking down what each different configuration files is used for and 
giving example values.</p>
<!--aka-break-->

<p><strong>Edited October 12, 2017</strong>: Corrected the <code>bmAttributes</code> value used and added explanation for the values.</p>
<p><strong>Edited July 8, 2018</strong>: Tested on Raspbian Stretch (lite) 2018-06-27.</p>
<p><strong>Edited August 1, 2018</strong>: Added link to gist with gadget creation and tester scripts at the end of the post.</p>
<p><strong>Edited August 13, 2019</strong>: Updated link to USB HID document.</p>
<hr>
<h2>Post series index</h2>
<ol>
<li><a href="https://www.rmedgar.com/blog/using-rpi-zero-as-keyboard-setup-and-device-definition">Setup and device definition</a> (this post)</li>
<li><a href="https://www.rmedgar.com/blog/using-rpi-zero-as-keyboard-report-descriptor">Report descriptor</a></li>
<li><a href="https://www.rmedgar.com/blog/using-rpi-zero-as-keyboard-send-reports">Sending and receiving reports</a></li>
</ol>
<hr>
<h2>ConfigFS</h2>
<p>First, let's talk about ConfigFS. For this part, I'm going to 
reference a brilliant presentation by Matt Porter [1], which greatly 
summarizes the key points of ConfigFS.</p>
<p>In essence, ConfigFS is a virtual filesystem which exposes a 
userspace API for the creation of USB devices. This was introduced in 
Linux 3.11, and recent versions of the Raspbian operating system already
 include the module.</p>
<p>Furthermore, this allows creating several devices at the same time, 
meaning that the Pi can act as a composite USB device with different 
functionalities.</p>
<h2>Usage in Raspberry Pi Zero</h2>
<p>First, let's assume that we have a microSD card with the following 
two partitions created when writing the official Raspbian image to the 
card:</p>
<ul>
<li><code>BOOT</code>: contains the configuration applied during boot time</li>
<li><code>DATA</code>: contains the filesystem of the OS</li>
</ul>
<p>Before using ConfigFS, it is necessary to load the module. Although it should be possible to use <code>modprobe</code> for this, it's just easier to add the following line at the end of <code>BOOT/config.txt</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nv">dtoverlay</span><span class="o">=</span>dwc2
</code></pre></div>


<p>And the following two lines at the end of <code>DATA/etc/modules</code>:</p>
<div class="highlight"><pre><span></span><code>dwc2
libcomposite
</code></pre></div>


<p>Once done, ConfigFS will be loaded in <code>/sys/kernel/config/usb_gadget</code> when the Pi is started.</p>
<h2>Defining a USB device</h2>
<p>The way to define a new device in ConfigFS is to create a directory inside the virtual filesystem. <strong>Note</strong> that these commands are only for illustration purposes, as they are expected to be <strong>executed during runtime</strong>. For this example, the device will be called <code>mykeyboard</code>:</p>
<div class="highlight"><pre><span></span><code>mkdir /sys/kernel/config/usb_gadget/mykeyboard
<span class="nb">cd</span> /sys/kernel/config/usb_gadget/mykeyboard
</code></pre></div>


<p>Listing the contents of this new directory shows that several files 
and directories have been created automatically. The meaning of each 
individual file can be obtained from the official USB specification [2].
 Regarding the files:</p>
<ul>
<li><code>bcdDevice</code>: device release number, assigned by manufacturer (format: <code>0x0000</code>)</li>
<li><code>bcdUSB</code>: USB specification number that the device implements (format: <code>0x0000</code>)</li>
<li><code>bDeviceClass</code>: USB class code, assigned by USB organization (format: <code>0x00</code>) </li>
<li><code>bDeviceProtocol</code>: USB protocol code, assigned by USB organization (format: <code>0x00</code>)</li>
<li><code>bDeviceSubClass</code>: USB subclass code, assigned by USB organization (format: <code>0x00</code>)</li>
<li><code>bMaxPacketSize0</code>: maximum packet size for the device, only possible values are 8, 16, 32, and 64 (format: <code>0x00</code>)</li>
<li><code>idProduct</code>: product ID, assigned by manufacturer (format: <code>0x0000</code>)</li>
<li><code>idVendor</code>: vendor ID, assigned by USB organization (format: <code>0x0000</code>)</li>
<li><code>UDC</code>: USB Device Controller, used to attach the gadget to the UDC driver in the machine</li>
</ul>
<p>Note the <code>format</code> comment at the end of each file. This means that the file should <strong>contain the given number of hex characters</strong>. For example, if <code>0x0000</code> is shown, then the file must contain a 4-digit hexadecimal number, such as <code>0x12AB</code>.</p>
<p>Now, let's start writing content to these files. Vendor and product IDs can be obtained from the Linux USB project [3]:</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> 0x0100 &gt; bcdDevice <span class="c1"># Version 1.0.0</span>
<span class="nb">echo</span> 0x0200 &gt; bcdUSB <span class="c1"># USB 2.0</span>
<span class="nb">echo</span> 0x00 &gt; bDeviceClass
<span class="nb">echo</span> 0x00 &gt; bDeviceProtocol
<span class="nb">echo</span> 0x00 &gt; bDeviceSubClass
<span class="nb">echo</span> 0x08 &gt; bMaxPacketSize0
<span class="nb">echo</span> 0x0104 &gt; idProduct <span class="c1"># Multifunction Composite Gadget</span>
<span class="nb">echo</span> 0x1d6b &gt; idVendor <span class="c1"># Linux Foundation</span>
</code></pre></div>


<p>In addition, note that the following directories are also present:</p>
<ul>
<li><code>configs/</code>: contains specific configurations for the device</li>
<li><code>functions/</code>: defines the capabilities of the virtual device</li>
<li><code>os_desc/</code>: OS Descriptors (ignore it for now)</li>
<li><code>strings/</code>: localized description of the device (e.g. in English)</li>
</ul>
<p>Let's begin with the <strong>localization</strong>. For English, the hexadecimal code would be <code>0x409</code>, which must be created as a directory inside <code>strings/</code>. Once present, it is populated with three files:</p>
<ul>
<li><code>manufacturer</code> : name of the manufacturer of the device</li>
<li><code>product</code>: product name/description</li>
<li><code>serialnumber</code>: complete serial number of the product</li>
</ul>
<p>Therefore:</p>
<div class="highlight"><pre><span></span><code>mkdir strings/0x409

<span class="nb">echo</span> <span class="s2">"My manufacturer"</span> &gt; strings/0x409/manufacturer
<span class="nb">echo</span> <span class="s2">"My virtual keyboard"</span> &gt; strings/0x409/product
<span class="nb">echo</span> <span class="s2">"0123456789"</span> &gt; strings/0x409/serialnumber
</code></pre></div>


<p>Now let's define the functions of the device. ConfigFS supports many 
different types of devices, but in this case we are interested in a USB 
keyboard. In order to have the device behave like a HID, a directory 
named <code>hid.usb0</code> has to be created inside <code>functions/</code>. It contains the following files:</p>
<ul>
<li><code>protocol</code>: the protocol for the device</li>
<li><code>report_desc</code>: binary descriptor for the reports sent by the keyboard</li>
<li><code>report_length</code>: length of the reports sent by the keyboard</li>
<li><code>subclass</code>: type of HID</li>
</ul>
<p>For now we are going to ignore the <code>report_desc</code>, as I will cover that in the <a href="https://www.rmedgar.com/blog/using-rpi-zero-as-keyboard-report-descriptor">next post</a>, but we can write the values for the other files, as these are common for all keyboards:</p>
<div class="highlight"><pre><span></span><code>mkdir functions/hid.usb0

<span class="nb">echo</span> <span class="m">1</span> &gt; functions/hid.usb0/protocol
<span class="nb">echo</span> <span class="m">8</span> &gt; functions/hid.usb0/report_length <span class="c1"># 8-byte reports</span>
<span class="nb">echo</span> <span class="m">1</span> &gt; functions/hid.usb0/subclass
<span class="c1"># echo "..." &gt; functions/hid.usb0/report_desc # Check second post</span>
</code></pre></div>


<p>Lastly, for the configuration, creating a new directory inside <code>configs/</code> will include the following:</p>
<ul>
<li><code>MaxPower</code>: maximum power for the device (in mA)</li>
<li><code>bmAttributes</code>: configuration characteristics bitmask (in hex format: <code>0x00</code>), the following bits can be set depending on the power characteristics:<ul>
<li><em>bit 7</em>: bus powered (e.g. <code>10000000</code>)</li>
<li><em>bit 6</em>: self powered (e.g. <code>01000000</code>)</li>
<li><em>bit 5</em>: remote wakeup (e.g. <code>00100000</code>)</li>
<li><em>bit 4</em> to <em>bit 0</em>: reserved</li>
</ul>
</li>
<li><code>strings/</code>: directory for localization of the configuration description (we will use <code>0x409</code> for English, as before)</li>
</ul>
<p>Note that it is possible to set several bits in the <code>bmAttributes</code>
 bitmask at the same time. For instance, to indicate that the device is 
bus powered and has remote wakeup capabilities, the bitmask should be <code>10100000</code>, which in hex translates to <code>0xa0</code>.</p>
<p>Therefore:</p>
<div class="highlight"><pre><span></span><code>mkdir configs/c.1
mkdir configs/c.1/strings/0x409

<span class="nb">echo</span> 0x80 &gt; configs/c.1/bmAttributes <span class="c1"># Only bus powered</span>
<span class="nb">echo</span> <span class="m">100</span> &gt; configs/c.1/MaxPower <span class="c1"># 100 mA</span>
<span class="nb">echo</span> <span class="s2">"Example configuration"</span> &gt; configs/c.1/strings/0x409/configuration
</code></pre></div>


<p>Once that is set up, the HID function defined previously must be linked to the configuration like so:</p>
<div class="highlight"><pre><span></span><code>ln -s functions/hid.usb0 configs/c.1
</code></pre></div>


<h2>Activating the device</h2>
<p>Even though we are still missing the report descriptor, the device 
that was just configured can be activated by attaching the gadget to a 
UDC driver:</p>
<div class="highlight"><pre><span></span><code>ls /sys/class/udc &gt; UDC
</code></pre></div>


<p>After this (and after adding the report descriptor), the host to 
which the Pi is connected should recognize it as a USB keyboard.</p>
<h2>TL;DR</h2>
<p>The following script defines a USB keyboard as a gadget in ConfigFS. 
It should be executed by the Pi during runtime (e.g. on startup):</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># Create gadget</span>
mkdir /sys/kernel/config/usb_gadget/mykeyboard
<span class="nb">cd</span> /sys/kernel/config/usb_gadget/mykeyboard

<span class="c1"># Add basic information</span>
<span class="nb">echo</span> 0x0100 &gt; bcdDevice <span class="c1"># Version 1.0.0</span>
<span class="nb">echo</span> 0x0200 &gt; bcdUSB <span class="c1"># USB 2.0</span>
<span class="nb">echo</span> 0x00 &gt; bDeviceClass
<span class="nb">echo</span> 0x00 &gt; bDeviceProtocol
<span class="nb">echo</span> 0x00 &gt; bDeviceSubClass
<span class="nb">echo</span> 0x08 &gt; bMaxPacketSize0
<span class="nb">echo</span> 0x0104 &gt; idProduct <span class="c1"># Multifunction Composite Gadget</span>
<span class="nb">echo</span> 0x1d6b &gt; idVendor <span class="c1"># Linux Foundation</span>

<span class="c1"># Create English locale</span>
mkdir strings/0x409

<span class="nb">echo</span> <span class="s2">"My manufacturer"</span> &gt; strings/0x409/manufacturer
<span class="nb">echo</span> <span class="s2">"My virtual keyboard"</span> &gt; strings/0x409/product
<span class="nb">echo</span> <span class="s2">"0123456789"</span> &gt; strings/0x409/serialnumber

<span class="c1"># Create HID function</span>
mkdir functions/hid.usb0

<span class="nb">echo</span> <span class="m">1</span> &gt; functions/hid.usb0/protocol
<span class="nb">echo</span> <span class="m">8</span> &gt; functions/hid.usb0/report_length <span class="c1"># 8-byte reports</span>
<span class="nb">echo</span> <span class="m">1</span> &gt; functions/hid.usb0/subclass
<span class="c1"># echo "..." &gt; functions/hid.usb0/report_desc # Check second post</span>

<span class="c1"># Create configuration</span>
mkdir configs/c.1
mkdir configs/c.1/strings/0x409

<span class="nb">echo</span> 0x80 &gt; configs/c.1/bmAttributes
<span class="nb">echo</span> <span class="m">200</span> &gt; configs/c.1/MaxPower <span class="c1"># 200 mA</span>
<span class="nb">echo</span> <span class="s2">"Example configuration"</span> &gt; configs/c.1/strings/0x409/configuration

<span class="c1"># Link HID function to configuration</span>
ln -s functions/hid.usb0 configs/c.1

<span class="c1"># Enable gadget</span>
ls /sys/class/udc &gt; UDC
</code></pre></div>


<p><strong>Bonus:</strong> The previous snippet and the test scripts used in the next posts are available at <a href="https://gist.github.com/rmed/0d11b7225b3b772bb0dd89108ee93df0">https://gist.github.com/rmed/0d11b7225b3b772bb0dd89108ee93df0</a></p>
<h2>References</h2>
<ul>
<li>[1] <a href="https://www.elinux.org/images/e/ef/USB_Gadget_Configfs_API_0.pdf">https://www.elinux.org/images/e/ef/USB_Gadget_Configfs_API_0.pdf</a></li>
<li>[2] <a href="https://www.usb.org/sites/default/files/documents/hid1_11.pdf">https://www.usb.org/sites/default/files/documents/hid1_11.pdf</a></li>
<li>[3] <a href="http://www.linux-usb.org/usb.ids">http://www.linux-usb.org/usb.ids</a></li>
</ul>
<h2>Post series index</h2>
<ol>
<li><a href="https://www.rmedgar.com/blog/using-rpi-zero-as-keyboard-setup-and-device-definition">Setup and device definition</a> (this post)</li>
<li><a href="https://www.rmedgar.com/blog/using-rpi-zero-as-keyboard-report-descriptor">Report descriptor</a></li>
<li><a href="https://www.rmedgar.com/blog/using-rpi-zero-as-keyboard-send-reports">Sending and receiving reports</a></li>
</ol>
        </div>

        <div class="is-divider"></div>
        <div class="tags are-normal">
                <span class="tag is-info is-light is">
                    <a href="https://www.rmedgar.com/blog/tagged/configfs">configfs</a>
                </span>
                <span class="tag is-info is-light is">
                    <a href="https://www.rmedgar.com/blog/tagged/gadget">gadget</a>
                </span>
                <span class="tag is-info is-light is">
                    <a href="https://www.rmedgar.com/blog/tagged/hid">hid</a>
                </span>
                <span class="tag is-info is-light is">
                    <a href="https://www.rmedgar.com/blog/tagged/keyboard">keyboard</a>
                </span>
                <span class="tag is-info is-light is">
                    <a href="https://www.rmedgar.com/blog/tagged/linux">linux</a>
                </span>
                <span class="tag is-info is-light is">
                    <a href="https://www.rmedgar.com/blog/tagged/pi">pi</a>
                </span>
                <span class="tag is-info is-light is">
                    <a href="https://www.rmedgar.com/blog/tagged/raspberry-pi">raspberry pi</a>
                </span>
                <span class="tag is-info is-light is">
                    <a href="https://www.rmedgar.com/blog/tagged/rpi">rpi</a>
                </span>
                <span class="tag is-info is-light is">
                    <a href="https://www.rmedgar.com/blog/tagged/zero">zero</a>
                </span>
        </div>

    </article>

        <div id="comments" class="mt-4">

    <section id="remark42"><iframe src="Tutorial%20%20Part%201%20Setup%20and%20device%20definition_files/iframe.html" name="{&quot;__colors__&quot;:{}}" allowtransparency="true" scrolling="no" tabindex="0" title="Comments | Remark42" horizontalscrolling="no" verticalscrolling="no" style="width: 1px !important; min-width: 100% !important; border: medium none !important; overflow: hidden !important; margin: -6px; height: 6860px;" width="100%" frameborder="0"></iframe></section>

    <script>
        var remark_config = {
            host: "https://comments.rmedgar.com",
            site_id: "www.rmedgar.com",
            components: ["embed",],
            url: "https://www.rmedgar.com/blog/using-rpi-zero-as-keyboard-setup-and-device-definition",
            max_shown_comments: 15,
            theme: "light",
            page_title: "Using RPi Zero as a Keyboard Part 1: Setup and device definition",
            show_email_subscription: true
        };

        (function(c) {
            for(var i = 0; i < c.length; i++){
                var d = document, s = d.createElement('script');
                s.src = remark_config.host + '/web/' +c[i] +'.js';
                s.defer = true;
                (d.head || d.body).appendChild(s);
            }
        })(remark_config.components || ['embed']);
    </script>
        </div>
</div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="columns">
                <div id="left-footer" class="column is-4">
                    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="Tutorial%20%20Part%201%20Setup%20and%20device%20definition_files/88x31.png"></a><br>Unless otherwise specified, this work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
                </div>
                <div id="right-footer" class="column is-4 is-offset-4">
                </div>
            </div>
        </div>
    </footer>


</body></html>